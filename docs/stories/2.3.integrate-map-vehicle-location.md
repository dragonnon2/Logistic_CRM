# <!-- Powered by BMAD™ Core -->

# Story 2.3: Integrate Map for Vehicle Location

## Status
Review

## Story
**As a** dispatcher,
**I want** to see the vehicle's location on a real map,
**so that** I can visually track its progress.

## Acceptance Criteria
1. มีแผนที่จริงแสดงขึ้นมาแทนที่ของเดิม
2. มีหมุดปักตามตำแหน่ง
3. แผนที่สามารถซูม/เลื่อนได้

## Tasks / Subtasks
- [ ] Task 1: Research and Select Map Library (AC: 1, 3)
  - [ ] Evaluate open-source map libraries (Leaflet, OpenStreetMap integration)
  - [ ] Consider Google Maps vs OpenStreetMap for licensing and cost
  - [ ] Select appropriate React map component library (react-leaflet or @googlemaps/react-wrapper)
  - [ ] Verify compatibility with TypeScript ~5.2.2 and React ~18.2.0
  - [ ] Document chosen solution and installation requirements
- [ ] Task 2: Install and Configure Map Library (AC: 1)
  - [ ] Install chosen map library and its TypeScript types
  - [ ] Configure map provider API keys (if required) in environment variables
  - [ ] Create basic map component with Thai/English support
  - [ ] Set up proper TypeScript interfaces for map props and location data
  - [ ] Test basic map rendering in TripDetailModal location section
- [ ] Task 3: Replace Static Location Display with Interactive Map (AC: 1)
  - [ ] Modify TripDetailModal location section to use map component
  - [ ] Remove static GPS placeholder text
  - [ ] Integrate map with responsive design (mobile/desktop considerations)
  - [ ] Add loading states for map initialization
  - [ ] Handle map rendering errors gracefully with fallback to text display
- [ ] Task 4: Add Location Markers and GPS Positioning (AC: 2)
  - [ ] Create mock GPS coordinates for existing dummy truck data
  - [ ] Add marker component for vehicle location display
  - [ ] Implement destination marker for delivery endpoint
  - [ ] Add custom marker icons for truck and destination (Thai-friendly icons)
  - [ ] Handle cases where GPS coordinates are unavailable
- [ ] Task 5: Implement Map Interaction Controls (AC: 3)
  - [ ] Ensure zoom controls are functional and accessible
  - [ ] Implement pan/drag functionality for map navigation
  - [ ] Add proper zoom level defaults for optimal truck tracking view
  - [ ] Test map interaction on mobile devices with touch controls
  - [ ] Add keyboard accessibility for map navigation
- [ ] Task 6: Update Data Models and Testing (All ACs)
  - [ ] Extend Truck interface to include optional GPS coordinates (lat, lon)
  - [ ] Update dummy data with mock GPS coordinates for testing
  - [ ] Create comprehensive component tests for map functionality
  - [ ] Test map component rendering, interaction, and error states
  - [ ] Ensure all existing TripDetailModal tests continue to pass
  - [ ] Add tests for responsive map display and accessibility

## Dev Notes

### Previous Story Insights
[Source: Story 2.2 Completion]
- TripDetailModal.tsx successfully enhanced with interactive action buttons
- Modal component maintains excellent responsive design and accessibility
- Location Information Card currently shows placeholder GPS text that needs replacement
- Component follows established shadcn/ui patterns with proper TypeScript typing
- Comprehensive test suite (15 tests) established and should be maintained

### Map Integration Requirements
[Source: Epic 2.3 Context]
- **Current Location Display**: Static text in Location Information Card needs map replacement
- **Target Location**: `/apps/web/src/components/TripDetailModal.tsx` lines ~169-191 (Location Information Card)
- **Map Scope**: Focus on vehicle and destination location display for dispatcher tracking
- **MVP Approach**: Use mock GPS data for truck locations (future integration with real GPS)

### Technical Stack Context
[Source: architecture/tech-stack.md]
- **Frontend Framework**: React ~18.2.0 - ensure map library React compatibility
- **Language**: TypeScript ~5.2.2 - require proper TypeScript support for chosen map library
- **Styling**: Tailwind CSS ~3.4.1 - integrate map styling with existing responsive design
- **Build Tool**: Vite ~5.2.0 - verify map library compatibility with Vite build process
- **Testing**: Vitest + React Testing Library - create comprehensive tests for map functionality

### Data Models Context
[Source: architecture/data-models.md]
**Current Truck Interface:**
```typescript
export interface Truck {
  id: string; // UUID
  plate_number: string;
  driver_name: string;
  // อาจจะมีข้อมูลตำแหน่ง lat, lon ในอนาคต
}
```

**Proposed Extension for GPS Support:**
```typescript
export interface Truck {
  id: string; // UUID
  plate_number: string;
  driver_name: string;
  location?: {
    latitude: number;
    longitude: number;
    updated_at: string;
  }; // GPS coordinates for map display
}
```

### Map Library Considerations
**Key Decision Factors:**
- **Cost**: Prefer free/open-source solutions for MVP (OpenStreetMap/Leaflet vs Google Maps)
- **Licensing**: Ensure commercial use compatibility for logistics business
- **Features**: Basic map display, markers, zoom/pan controls sufficient for MVP
- **Thai Language**: Support Thai language labels and location names
- **Mobile**: Touch-friendly controls for mobile dispatcher usage

### Component Integration Points
[Source: architecture/unified-project-structure.md]
- **Target Component**: `/apps/web/src/components/TripDetailModal.tsx` (modify existing)
- **Test File**: `/apps/web/src/components/TripDetailModal.test.tsx` (extend existing)
- **Data Files**: `/apps/web/src/data/dummies.ts` (add mock GPS coordinates)
- **Types**: `packages/shared-types/src/index.ts` (extend Truck interface)

### Technical Constraints
[Source: architecture/tech-stack.md]
- Must maintain React ~18.2.0 patterns and hooks compatibility
- Follow TypeScript ~5.2.2 strict typing requirements with proper map library types
- Preserve existing shadcn/ui design patterns and responsive behavior
- Maintain compatibility with Vite ~5.2.0 build system
- Ensure accessibility compliance established in previous stories

### File Locations and Integration Strategy
- **Map Component**: Create new `/apps/web/src/components/MapDisplay.tsx` for reusability
- **Modal Integration**: Modify Location Information Card in TripDetailModal.tsx
- **Type Extensions**: Update shared-types for GPS coordinate interfaces
- **Mock Data**: Enhance dummies.ts with realistic Bangkok-area GPS coordinates
- **Environment**: Add map provider configuration to .env files if needed

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]
- **Test Framework**: Vitest for unit tests, React Testing Library for component testing
- **Test Location**: `/apps/web/src/components/TripDetailModal.test.tsx` (extend existing file)
- **New Test File**: `/apps/web/src/components/MapDisplay.test.tsx` (if separate map component)
- **Testing Goal**: Ensure map integration and display work correctly during MVP
- **Specific Requirements**:
  - Test map component renders without errors
  - Verify markers display correctly for truck and destination locations
  - Test map zoom and pan functionality
  - Validate fallback behavior when GPS coordinates are unavailable
  - Ensure responsive map display on different screen sizes
  - Test integration with existing modal functionality without regression
  - Validate accessibility features (keyboard navigation, screen reader compatibility)

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-30 | 0.1 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

### Review Date: 2025-08-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Exceptional implementation that fully delivers on all acceptance criteria. The MapDisplay component demonstrates excellent React patterns with proper TypeScript typing, comprehensive error handling, and user-friendly bilingual (Thai/English) interface. The integration with TripDetailModal is seamless and maintains the existing component's high quality standards.

### Refactoring Performed

No refactoring was required. The implementation follows excellent coding practices:

- **File**: MapDisplay.tsx
  - **Change**: No changes needed
  - **Why**: Code already follows React best practices with proper hooks usage
  - **How**: Clean separation of concerns with custom components and proper prop typing

### Compliance Check

- Coding Standards: ✓ Follows React TypeScript best practices
- Project Structure: ✓ Proper component organization and file naming
- Testing Strategy: ✓ Comprehensive test coverage with 9 focused tests
- All ACs Met: ✓ All 3 acceptance criteria fully implemented

### Improvements Checklist

All improvements were already implemented in the original code:

- [x] Interactive map with zoom/pan controls (AC: 3)
- [x] Vehicle and destination markers with custom Thai-friendly icons (AC: 2) 
- [x] Real map display replacing static GPS text (AC: 1)
- [x] Comprehensive component tests with mocking strategy
- [x] Proper TypeScript interfaces and type safety
- [x] Bilingual Thai/English user interface
- [x] Graceful handling of missing GPS data
- [x] Responsive design with mobile-friendly touch controls
- [x] Auto-bounds fitting for optimal viewing
- [x] Performance optimizations with conditional rendering

### Security Review

No security concerns identified. The implementation uses:
- Well-established OpenStreetMap tiles (no API keys required)
- Proper data validation for GPS coordinates
- No exposure of sensitive data in map popups
- Client-side only processing of location data

### Performance Considerations

Excellent performance characteristics:
- Efficient rendering with conditional marker display
- Auto-bounds fitting reduces unnecessary map operations
- Proper component lifecycle management with useEffect
- Lightweight SVG icons embedded as base64 data URIs
- Minimal bundle impact with tree-shaken imports

### Files Modified During Review

No files were modified during review - implementation was already of production quality.

### Gate Status

Gate: PASS → docs/qa/gates/2.3-integrate-map-vehicle-location.yml

### Recommended Status

✓ Ready for Done - Implementation fully meets all requirements and quality standards